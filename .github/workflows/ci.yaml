name: Tests and Checks

on: [push]

env:
  REACT_APP_CHAIN_ID: 5
  IS_CI_ENV: true
  REACT_APP_THEGRAPH_ENDPOINT: https://gateway.thegraph.com/api/64b2ea62b6f163e106a8b4d699a26dff/deployments/id/QmNkNXwA7Cr59Rm48Y5EcWBRuusFGpBKZrL1fNygRzbX8Q

jobs:
  typecheck:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: 16
          cache: 'yarn'

      - name: Install deps
        run: yarn

      - name: TSC
        run: yarn run typecheck

  lint:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: 16
          cache: 'yarn'

      - name: Install deps
        run: yarn

      - name: Lint
        run: yarn lint

      - name: pretty
        run: yarn pretty

      - name: Lint styles
        run: yarn lint-styles

  test:
    permissions:
      checks: write
      pull-requests: write
      contents: write
    runs-on: ubuntu-20.04
    container:
      image: node:14.15.1-buster
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: 16
          cache: 'yarn'

      - name: Install deps
        run: yarn

      - name: Run tests
        run:
          yarn test --ci --json --coverage --testLocationInResults
          --outputFile=./coverage/report.json

      - uses: ArtiomTr/jest-coverage-report-action@v2
        with:
          package-manager: yarn
          coverage-file: ./coverage/report.json
          skip-step: all
          github-token: ${{ secrets.GITHUB_TOKEN }}
